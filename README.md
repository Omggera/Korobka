# Доставка на маркет

![](https://lh3.googleusercontent.com/fife/AAbDypB6cXICOv9m3SllM6AWFBNWj9yS_zrE9y8eekwH_c-lGUwpSRGj1u6dqjWcDdtPP_WX9JrsKtElE586YOxomrlqTAFqZWhu3FXfPaFSXpQN1dSr38GQsHdp493-kEelkOogijdFHXGmqzxwKRy5XJ_LoqBA7iVeueBGFgpSauYfWcF-vAYi5Ph3BcOM2EZv0evXTgT4-kkhXFHyR2yTBCXG3sqlRyaPrrgen9Uc94IbXH4JwyTxZjDx0mLpXT1oo49kmXp3suLBGRt8du-09ygKCyxqVCjIAOrkjJJIfKxH0CKbVCjkbAgWhxah0xBJnHNjw8u1SgYmxK32_ZgjZZ5aCYKWgBgPEtgxZ6QfxACDxgRmIN551qaHQ76-SndeHliLfCMVsv4dwdSXVgD46-1gw8YlcgG2PSx0GDBONbOBp2ocIG-Kh_Sb761xuH276L-2ayb_hrf-hCSpOEJ2yeUXAtxELI7HOgJWmLkSnft-XRydzuJTPDpd7qgpv3TquYp5410NXx4w8tqSQKdeidLp5PnwNjaEXJxCLgKwj2P7DZy0uWrL9KimBVYQOe8VJvQn_gZ7uXWHwLCh9WTRKbs8OsxkjqaUaRv7DPx9uhzkHDsINbYd40xaV1HTDpZndgI_xQalWlZqYYl-OSpmqh0fnV5pYQRYg_rcTT60m3MJYSvH1RQyYO7bwddS9Nm6QWVNr1wUayeze6TURZMeoLeiKbyv0YTU-p8XsaSNDVQzM6_eCkFaPFHmkiCGBg2nMzWKph-bDDRheBEnsWb-LcvlTdQk1mtCPQ-uLdBwRNvvjp5Vnf2FFfvVorPO_VjgDRKX1uD37u_GGnZlCzw3HbPRICX5Gew_PvBnlb_J5Ihg87pKclsh9Cx9lKOg0-EKchft-tb2wPq3yjEMRvzVbroXvgKmKNGoAc9uBD_So6ziX2Ez9noLxHjn0RqItM0jQi7C9tE9glaaA-9PTNsauGUzG7oYPNa_G0lKrwhQE6uHMoPQqZnzHiIbzXk76t5VsHAGaXKxXvlBicW8NtcwDwcP8FCqibvh_3VkHsesTdD80gvoig6_fuM4sxRiRLiSKZOqzuzu5j4N2gv2st9mrZdnQ8tt0VLSIvY33xt386VsJi1DyUiMtW_vMsjQlVfApnzZ4mAb1L_d6Ddtqu0cHzGI8DrQFDOh9opsXfRazJeq-meKSxPvOIeKpYXhs8LL2eJsp3jhWgFsqAWDCeYzRUQlv8BntonjpKX0QB_OBpFPTzW8R1lN8weYdsgHQV-BzfLoVDrLYZ2OjC9Kd_E3KDGK94taniNPsjOIVYjkSjcqA3FGfnVGcPNRhovP3c6zpQojmhZX6QCWJxIfZChfY-iCkX7KyUygf_F48XoOoGyJnKG_ceGQBc7Zy5i1auAXb1D15MWD6Y6yv8LYFQE4lwde3k3vsk8tmzaYCruE7jvt14idUMVweb1gDXf3eYcDg-F6T-H91eE3UMiVUVcOug=w1920-h940)

Мобильное приложение под ОС Android построенное на .NET MAUI - эволюции Xamarin.Forms. Оно выполняет функционал одноименного сайта [Доставка на маркет](https://na-market.ru/) (подробнее о нем можно узнать [перейдя по этой ссылке](https://github.com/Omggera/DostavkaNaMarket)).

.NET MAUI - это кросс-платформенная технология. Она объединяет API Android, iOS, macOS и Windows в единый API, который позволяет выполнять однократную запись в любом месте разработки, обеспечивая дополнительный доступ ко всем аспектам каждой платформы.

Приложение определяет системную тему (темная или светлая) и подстраивается под нее. Для удобства пользователей я добавил возможность переключить тему в ручном режиме.

![](https://lh3.googleusercontent.com/fife/AAbDypDUx9rsRFbk4cspEKvHTVWHL5eC3z-npghzllXfCzpcyPDkTVmnRnyAzww_ENGsJflANFyzkAsyGctK1leshnrrRNjADqXUw-YrktBVIeEWtLMGqd4fdNlArFN-cCgN53uzzQlo4p4URG9p4HbbBnybvFjl8LTDnG7YD2GZ3X5epfWHLjjlBtAOKG621vB4t26oXFf1YyhpY4RVuG84p_1ASu7Luol22idtBVhVMcT5kxOvMkwT65F1edaVB-r4DOgpEDDohd2xd_XZ-Z0B74C6yz6ld7Ofj2K0ITpKnVsWbwB208C7NId5N2sZdtgzMDpVwHV0EQB7gsrg0zFvegGn1XTecfF0KqxKUtsBBxAcAbNzcEAqVs_hqCYglY8wZgVVaRsF03GnMDyAxABRtdNG03VvKWOjSlem2KJ5iRm_ALbsdGaipjQfymw22C1XWhU7-5QKDLd6ojY-F97JZmxOR3MAWGm3IkyPbouc5Oys8VSOaLV9Z_TKgsC1kbwFkIMfQ9yG3L8iFYTlXh-TNYA2W-HhR9-o6WuJaNpj3pLr3M-tqOF0Cm-Y7axxUYAKqxmaWyQU4roSJYjg4lPXTdLasAG22IynWCf-yvJkaQVl_zeO4Fxhs9DyCkv-MRLZgozgSXbpOliEFXxWjypQ1982l9rADanCLqQSRiFqUeXCtLHzSjEg-NbYgRIqxqEkNUglYx537oTpG8qkEsnJ2AXfDR52Gfd5cJkMuhPzreMA7DHdvnjRTgpHLn3Wsdk_gg_X46BUb421HrN1jItdnRuWpNCQ5eaFQf3nBKDq4_Yj7fMwxoK12uhClJQw88FG8TYpMfvjA-JQxS8XDu3VATQemQeNbSNsJnumT6C53_ppl28pyMqY7GPNBLQ3A5VUQw_5Jkj4ArJIHvMEz2JIrgHmw6Zv6mgBztnyDEdmAtT2QREj4EsRY37pRvbtl_U5AO7ymWKSvsdSPvNEpXL1Qe9r8PHivTocVUlMvdbWCHj2WOoBWLU1OF5QUcdl3cuhOX5g4nfcYsVdJA1uQmEZva6vjDYVboxhVdHnZE-Zn0qnYVK2vN5B1HCnM1_8biQqtSWlH-z-NXx_3Fh0VWaYB_cH3BvyuwC41emCIUnr59GTLF02KPXch9WSzTWkibBPhc2Z-zVy4CL9m-Imwgs7akx2KDDm7iOBMAP9Y_TK0j8NhECDMYGvko8CwTRx7-7buEk0ulSkpkEIBXz-0wq6IGvjoa0VZAPS3KoI5avK_eAd_NwFKaNV6NmC4ds4ibx202G1jWgDJLMEnJ9l6FBOAf2hrmNsIiVacliQZChAUDf2VGHKwQHhXcABc4DI_V0-7t93tAJJTzeqrBHqVTS2Oo-jZCq0nE7wcCcFIjx9pPU3s_-m7bygxLEv_Jni2V0rMjV54xdHGd6erliSqLn21e6kGFpnXGOlfFpQiWaL2Fhj_s7VgzyR9q9C1QB_TbzLpEd3yUBsdnro7gzQeFvTwQ=w1920-h940)

Организация "Доставка на маркет" занимается доставкой товаров поставщиков до складов Wildberries и работает в нескольких городах. У неё есть четко заданные дни отправки на два склада. По понедельникам в Коледино, по средам в Электросталь.

На ключевых полях в форме проводится проверка введенных данных. Если их не заполнить, то валидация не позволит создать заявку.

![](https://lh3.googleusercontent.com/fife/AAbDypAyUsiJm_rpGI60PiIitcdhThpPMurp6ga5DwemH1DaOTmYhalvu8TL7BsCiFjTSabSejrIrCDjUehpIJh4jTUdK_0r1pJopB_2tS6W8Ro0gtTm3PtCVhTR5hFhZw7jUWnRxF6og6jCP7PAQ3y5Imp1DWS7O0KsoaGtOO-vq_3blttQkmJcJdssYIoIP0pb7iDEm0mD68Y8O1Nzv1cIDPgT4yQSkUi8bLfbmGhrHQm81e9bdCj5ANIG9RTOdb2N0NDrjFXlc1MLDHoyA5-D8PMa336LDRHAUzcpSQO8U-63h_KWXJn0RNROR_tz0otafj3gN-2Vtm0Fu4ReD7a6TaR8USaovT6g8umaCVszSOIEDdPr1ihUmoVCBGyyZZSjVZaw4pB1aQEcV_eQbJdZOQGtdLWK6DyPKVNc0v8wkGLWxwidQL3xWgCep39pvom3ArGvnrsSuilwEJDYRGru-EnyhJ5C_y7wgtznQNB0_Auf8itEfhvWtX9nB-_oL7twb4wkcCYU-7Jx0Yg9p0SuNgDGfzwh6sFSx9jY3gioyd1Pad8NhDW7om5BJ5_RBo4gBDGfBVKbBccLIZhIR3BrJMOi9Gs3N8YerlQlbWAnqkvxnhX7NawCkW2pYJzRXp5ktWucDCEMN_hRTd38paZ3kNEMpq6H6OTearaEUeU7-N-xfnxtM96uxgsldJOkiK3u3JtE7h2qsb2Dbwa7DGJWLtrIwv32BL63mfgXoAGdMgDXaU5Qb68NbYDfXrdljslElSHcG4xsHv7pqE2gDUNbi6oMukY9oGjxA5B2ZFOtoCFObd89aNFP44Rhx1VoFyHDz1lqh115i_cGW7E4vDvTgWWXSkjGTZvcXp1HpDpWX09Exo4bXLi0u4S1WKxVBlOj7soEdHOhYbo-IJxT5sqwlReqYF_Q56WuhY4UB9tdAs1jq28_ctbuG-xrobP0wml0hUCMYgmmgcCXW1ka-usr3dxRsod2SFSH9rEdkGn0vtr0EWvqGr0lq4JwnXKnGHxYP8_CEnqS9QYyijtxh_uxO60_yPgJVoSoI4cf03W-RWhSd3fgKTjxTG5RchpAhdnpodurIfkWcbaK3BNqDNbALzsLiIzoTWw5I16q43-6DnTjGX0X1fiexuFe94hfgCRG22ZxLepM0bQV7aq_WIwt-k20Ubqbf05XKGN_dLnoWvMAvd7TS3OsviRfPY-XFgGErKRg7cPqAo-VhqSmJpHr-cuHlB8aNn4W5OaG707XAML2EHwJnrnvN4PkEyRpc_g4KYaDMFJSegs-6O_N2ZSTWFAl0Ttnuw4gZOecGVb791CcaI4TGSk8CxbxsbeU6iou22mptxapslBNfAjicJgqpl2gPlqwPqbrqudmDXRBH1ikmSLMBIAG9Dl1tS5pdh_GZOMfFLbogrYFmJqH0p01n0ix6ks8y-BLP3C3_OieXZe39HP4ckTSQam8L-P79AxfaHi35he_hRsgON9zu1dNZQ=w1920-h940)

Реализуется это с помощью собственного метода валидации формы.

````c#
[RelayCommand]
void ValidationForm()
{
	if((NameEntry != null) & (NameEntry != "")) ValidNameEntry = true;
	else ValidNameEntry = false;

	if ((TelephoneEntry != null) & (TelephoneEntry != "")) ValidTelephoneEntry = true;
	else ValidTelephoneEntry = false;

	if ((ValidNameEntry == true) & (ValidTelephoneEntry == true) & (ValidCheckBox == true))
	{
		ValidGlobal = true;
		IsReadOnlyNameEntry = true;
		IsReadOnlyTelephoneEntry = true;
		AttentionLabel = false;
	}
		
	else
	{
		ValidGlobal = false;
		IsReadOnlyNameEntry = false;
		IsReadOnlyTelephoneEntry = false;

		if ((ValidNameEntry == true) & (ValidTelephoneEntry == true) & (ValidCheckBox == false))
			AttentionLabel = false;
		else AttentionLabel = true;

		ValidCheckBox = false;
	}  
}
````

`[RelayCommand]` это один из "механизмов" .NET MAUI Community Toolkit. Он позволяет реализовать командный интерфейс в удобном виде. Community Toolkit устанавливается через NuGet. Далее создается `partial` класс наследующийся от  `ObservableObject`. 

````c# 
public partial class MainViewModel: ObservableObject
````

В нем прописываются поля, например:

````c#        
[ObservableProperty]
string emailEntry;
````
 
 `[ObservableProperty]` означает, что это поле будет отслеживаемым. В конструкторе класса или методах это же поле должно начинаться с заглавной буквы - `EmailEntry`.

В моём случае мое MVVM представление привязано к странице `MainPage.xaml` и соответственно `MainPage.xaml.cs`. Привязка осуществляется следующим образом:

В `MauiProgram.cs` регистрируем в службе зависимостей:

````c#
builder.Services.AddSingleton<MainPage>();
builder.Services.AddSingleton<MainViewModel>();
````

В `MainPage.xaml` мы объявляем:

````xaml
xmlns:viewmodel="clr-namespace:Korobka.ViewModel"
x:DataType="viewmodel:MainViewModel"
xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
````

Первая строка указывает, что мы обращается к элементу, который находится в папке `ViewModel`. Вторая указывает к каким данным идет привязка `MainViewModel`. Последняя строка подключает использование `.NET MAUI Community Toolkit` на этой странице.

В `MainPage.xaml.cs` (убрал все лишнее для демонстрации):

````c#
using Korobka.ViewModel;

namespace Korobka;

public partial class MainPage : ContentPage
{
    public MainPage(MainViewModel vm)
	{
		InitializeComponent();
        BindingContext = vm;
	}
}
````

`BindingContext` - контекст привязки данных. Файл .cs неразрывно связан с файлом .xaml и поэтому в нем обязательно нужно указать новую привязку к новой MVVM модели.

У .NET MAUI Community Toolkit есть поддержка валидации, но мне нужно было учитывать изменения определенных значений под свои цели.

Выбирая способ передачи "Привезу самостоятельно", появляется окно ввода адреса. Как только он будет введен, произойдет пересчет итоговой цены и в графе "Вывоз" будет указана сумма за эту услугу.

Введенные ШК коробок попадают в `ObservableCollection`. Она отслеживает изменения в коллекции. Это позволяет отображать новые и скрывать удаленные значения из коллекции без обновления страницы.

Ошибочно введенные ШК можно удалить если свайпнуть влево и нажать на кнопку "Удалить". Это возможность есть благодаря использованию `CollectionView`. CollectionView позволяет представить данные в виде списков. Свайп можно настроить на любую сторону. Менять цвета, отступы и многое другое. В xaml это выглядит следующим образом:

````c#
<CollectionView 
	IsVisible="true"
	ItemsSource="{Binding BarcodesList}"
	ItemsLayout="VerticalGrid, 2"
	SelectionMode="Single">
	<CollectionView.ItemTemplate>
		<DataTemplate x:DataType="{x:Type x:String}">
			<SwipeView >
				<SwipeView.RightItems>
					<SwipeItems>
						<SwipeItem 
							Text="Удалить"
							BackgroundColor="#A1000E"
							Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:MainViewModel}}, Path=DeleteCommand}"
							CommandParameter="{Binding .}" />
					</SwipeItems>
				</SwipeView.RightItems>
				<Frame 
					BorderColor="Gray" 
					HasShadow="False" 
					CornerRadius="0"
					Margin="0,0,1,1"
					HeightRequest="40"
					Padding="8">
					<StackLayout>
						<Grid 
							RowDefinitions="Auto"
							ColumnDefinitions="Auto,Auto">
							<Label 
								Text="{Binding .}"
								FontSize="16"
								HorizontalOptions="End"
								VerticalOptions="End"/>
						</Grid>
					</StackLayout>
				</Frame>
			</SwipeView>
		</DataTemplate>
	</CollectionView.ItemTemplate>
</CollectionView>
````

Выбирая оплату "Картой", итоговая сумма будет пересчитана. К ней добавится 2%.

![](https://lh3.googleusercontent.com/fife/AAbDypCpQihHNpH_NKLWbcXyLOvPv3cwL24gQaiJKYPvWoM13xZQzEkKrHUo5Se2Pw26S5plsEhBFH08VvFZDTwL_r9wxRAeyQcnsLKc6Y0zPVbudrMzdUTrhUw2IOjjQYlg0FXaYaiP1z8Ri75fEnO2KVa6CkTwz2gweh8nBuWbwk2wwjn9VKo9uFq2afefHTdRE29tSWWsgKJhLJ_QKoakgvDVr-7CUrpv0u2FC721J-k8Tb77BrE5CB1Juib8AYxxB9bCi79LPDbww-vSgc4qQsQyotEvOdnlLVNQ4pM0BXuUixNZ4De8jSjr1f-q-oT9k2ET38ZkoA5GGREYu9_rbircObm7JsXJXcYxXE0nUKGb1aFcwFRTLtaEPGDyL5JSWkKBV3BK_G9fAaZVCuXEP-Mq_s18qmDqoe2MaXsiT-ARVq-1NCORvnbS5hIOYtYi1WsN4h-LW4XLkNFpw8nt6za9CF8ambVKBwwjmhs8Un9UrXWwy52lja6-6Ac6QsmUGNhcBXgEUykH9U3sbfmMna7vby7IoASinjRLFpxcSlkKroFNGllEpGTcUGMHWc01VyyS3V47EIdU_1vT5BgU-O68Z9yS9febEZT10wn3x2WKyntf5ZOsjysNk2h3qzkptZ24zCkeh9LcbpaTDzycjNpY0OS9jGLwAphr8tWWLOyYn-gOKlYhpf3Ax4Um6GDhySkc_pHSRrXkzsLvlWBM13Sis9d893JXvNPYWddTHWzEfxFthpSSJcVknAPEH0dEzSOBfj3GHEeAqHoMOIrlt2HlmmYQvuzFT9rlXRl0Hma-uEPrZhqvIwhI3Bw_fTn1NcqRRXIECkhfOnUuXbHlQHf7Vmb3F_uOwATFlCji6oaFzGY1E4YIH6B2NsM2kVPKS9O5MDxohuz4romQVVZ9LDp11yhNP9KVOJ6PZPCrB5GfPcCTKL7GwXPSe813xjVHmfQOD0rKNnbUb_wr63SEZSMub-BhUSja8LzXXq5LRhJtJ-VD1qYY_iMQ8FZmTFhBAaOGgkK7V8CEOxCgu4eJBeatunRfZ-gg--a0UJc7SKSv5jFE9VhOe6fprEGUXk4BQ5rNcblrTSTgCU22VARGeXO-aAhTM-vFXwATQHZerzwVKjPB2GuHWeWNOVH_EPg9Utnse4t2SXfB2He1cCGjgcF1-JlEplY_hTkUEsPSJ2AgvwVs4Nc3hPypaBi530ArrPXYl2tjWP0Ce1TCp8XlI5sWG_HBYSq1JUA8aozebxFUZ6DBrPnM-CAZlMvFvnxcvhOnOw6cOwTXEtuKFAlne0Oxcai7HJMJuOgG1lETvL4J7_CN8LzOyrXA7BtpBC9P_Bby2n9khN43Xdzk7FTQuGeT5wptbPEjz5z_3SbpeCU_KEgBytqMA2w7hQ6983hA_Orz7ud1nUlvsztl-qzbhHDaStLtAgANglc653dj4NbRDYehbh46Swmt0ZW-IOq_NScsuq_jL0K0nWm5L1Ua7A=w1920-h940)

После нажатия на кнопку "Создать заявку", метод `Create()` отправляет все данные в базу данных MongoDB и возвращает страницу "Создать заявку" в первозданный вид.

````c#
[RelayCommand]
void Create()
{
	//Присваиваем заявке новый номер
	OrderNum = Mongo.AllDocCount() + 1;

	//Добавляем данные в БД
	BsonDocument doc = new BsonDocument
	{
	{"orderNum",$"{OrderNum}"},
	{"status","Новый"},
	{"dateOrder",$"{DateNewOrderUTC}"},
	{"city",$"{CitySelectedItem}"},
	{"dateDevivery",$"{SelectionWarehouse}"},
	{"clientName",$"{NameEntry}"},
	{"clientPhone",$"{TelephoneEntry}"},
	{"clientMail",$"{EmailEntry}"},
	{"getMethod",$"{SelectionGetMethod}"},
	{"clientAdress",$"{Adress}"},
	{"paymentMethod",$"{SelectionPaymentMethod}"},
	{"finalAmount",$"{FinalAmount}"},
	{"barcodes", new BsonArray(BarcodesList)}
	};

	mongo.AddDoc(doc).GetAwaiter();

	//Придаем форме первозданный вид
	CitySelectedItem = "Владимир";
	SelectionGetMethod = "Привезет самостоятельно";
	SelectionPaymentMethod = "Наличные";
	NameEntry = "";
	TelephoneEntry = "";
	EmailEntry = "";
	Adress = "";
	ValidGlobal = false;
	IsReadOnlyNameEntry = false;
	IsReadOnlyTelephoneEntry = false;
	ValidCheckBox = false;
	AttentionLabel = false;
	BarcodesList.Clear();
	CalculateFinalAmount();
}
````

Немного о подключении к базе данных. Она развернута на сервере, где лежит сам сайт. Чтобы получить к ней доступ надо в исходном коде указать данные для подключения: логин на сервере, хост и пароль. Такие данные в коде я оставить не мог. Поэтому я написал минимальный веб-API, который по get запросу отправляет эти данные в виде json.

API развернут на сервере. Для подключения к нему использую библиотеку `Renci.SshNet`, а для десериализации json данных библиотеку `Newtonsoft.Json`. Полный код в файле `Models/MongoDB.cs`
